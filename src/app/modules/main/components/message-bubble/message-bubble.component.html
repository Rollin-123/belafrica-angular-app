<div
  [id]="'message-' + message.id"
  class="bel-message-wrapper"
  [class.my-message]="isMyMessage()"
  [class.other-message]="!isMyMessage()"
  (contextmenu)="onContextMenu($event)"
  (touchstart)="onTouchStart($event)"
  (touchend)="onTouchEnd($event)">

  <div class="bel-message-bubble">

    <!-- INDICATEUR DE RÉPONSE -->
    @if (message.replyTo) {
      <div class="bel-reply-indicator"
        (click)="onScrollToClick(message.replyTo.messageId)">
        <div class="bel-reply-line"></div>
        <div class="bel-reply-content">
          <strong>{{ message.replyTo.fromUserName }}</strong>
          <p>{{ getReplyPreview(message) }}</p>
        </div>
      </div>
    }

    <!-- MODE ÉDITION -->
    @if (editingMessageId === message.id) {
      <div class="bel-message-edit">
        <textarea
          class="bel-edit-input"
          [value]="editMessageContent"
          (input)="onEditInput($event)"
          (keydown)="editKeydown.emit({ event: $event, message: message })"
          rows="3"
          placeholder="Modifier votre message...">
        </textarea>
        <div class="bel-edit-actions">
          <button class="bel-btn-cancel" (click)="cancelEditRequest.emit()">Annuler</button>
          <button class="bel-btn-save" (click)="saveEditRequest.emit()">Enregistrer</button>
        </div>
      </div>
    }

    <!-- AFFICHAGE NORMAL -->
    @if (editingMessageId !== message.id) {
      @if (!isMyMessage() && !message.isDeleted) {
        <div class="bel-message-header">
          <div class="bel-message-sender-info">
            @if (message.fromUserAvatar) {
              <img [src]="message.fromUserAvatar" class="bel-user-avatar" alt="Avatar">
            } @else {
              <div class="bel-user-avatar-placeholder">
                {{ message.fromUserName.charAt(0).toUpperCase() }}
              </div>
            }
            <strong class="bel-message-sender">{{ message.fromUserName }}</strong>
          </div>
        </div>
      }

      <div class="bel-message-content">
        @if (message.isDeleted) {
          <span class="bel-deleted-message">Message supprimé</span>
        } @else {
          <span [innerHTML]="formatMessageWithMentions(message)"></span>

          @if (message.isEdited) {
            <span class="bel-edited-badge">(modifié)</span>
          }
        }
      </div>

      <div class="bel-message-footer">
        <span class="bel-message-time">
          {{ formatMessageTime(message.timestamp) }}
        </span>

        @if (isMyMessage() && !message.isDeleted) {
          <div class="bel-message-status" [ngClass]="getMessageStatus(message)">
            @if (getMessageStatus(message) === 'status-sent') {
              <svg viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
            }
            @if (getMessageStatus(message) === 'status-delivered' || getMessageStatus(message) === 'status-read') {
              <svg viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.62 16.2l-3.54-3.54-1.41 1.41 4.95 4.95L23.66 7.02l-1.42-1.43zM4.41 12.41L3 13.82l4.95 4.95 1.41-1.41L4.41 12.41z"/></svg>
            }
            @if (getMessageStatus(message) === 'status-sending') {
              <div class="sending-spinner"></div>
            }
          </div>
        }
      </div>
    }
  </div>
</div>

<div class="bel-messaging-container">
  
   <div class="bel-emoji-overlay" 
       [class.active]="showEmojiPicker"
       (click)="showEmojiPicker = false">
  </div>
  <!-- Header Principal -->
  <header class="bel-messaging-header">
    <p>Communiquez avec votre communaut√© et vos contacts</p>
  </header>

  <!-- Navigation par Onglets -->
  <nav class="bel-messaging-tabs">
    <button 
      class="bel-tab-button" 
      [class.active]="activeTab === 'group'"
      (click)="setActiveTab('group')">
      üí¨ Chat de Groupe
    </button>
    <button 
      class="bel-tab-button" 
      [class.active]="activeTab === 'private'"
      (click)="setActiveTab('private')">
      üë§ Messages Priv√©s
    </button>
  </nav>

  <!-- Contenu des Onglets -->
  <main class="bel-messaging-content">
    
    <!-- ONGLET CHAT DE GROUPE -->
    @if (activeTab === 'group') {
      <div class="bel-group-chat-container">
        
        <!-- Header du Groupe -->
        <div class="bel-group-header">
          <div class="bel-group-info">
            <h2>Chat de Groupe - {{ userCommunity }}</h2>
          </div>
          <div class="bel-group-members">
            <span class="bel-members-count">üë• {{ (groupConversation$ | async)?.participants?.length || 0 }} membres</span>
          </div>
        </div>

        <!-- Zone des Messages -->
        <div class="bel-chat-messages" #messagesContainer>
          @if ((messages$ | async)?.length === 0) {
            <div class="bel-no-messages">
              <div class="bel-no-messages-icon">üí¨</div>
              <h3>Aucun message</h3>
              <p>Soyez le premier √† envoyer un message dans le groupe !</p>
            </div>
          } @else {
            <div class="bel-messages-list">
              @for (message of messages$ | async; track message.id) {
                <div 
                  [id]="'message-' + message.id"
                  class="bel-message-wrapper"
                  [class.my-message]="isMyMessage(message)"
                  [class.other-message]="!isMyMessage(message)"
                  (contextmenu)="showContextMenu($event, message)"
                  (touchstart)="onTouchStart($event, message)"
                  (touchend)="onTouchEnd($event, message)">
                  
                  <div class="bel-message-bubble">
                    
                    <!-- INDICATEUR DE R√âPONSE -->
                    @if (message.replyTo) {
                      <div class="bel-reply-indicator" 
                           (click)="scrollToMessage(message.replyTo!.messageId)">
                        <div class="bel-reply-line"></div>
                        <div class="bel-reply-content">
                          <strong>{{ message.replyTo.fromUserName }}</strong>
                          <p>{{ getReplyPreview(message) }}</p>
                        </div>
                      </div>
                    }

                    <!-- MODE √âDITION -->
                    @if (editingMessageId === message.id) {
                      <div class="bel-message-edit">
                        <textarea 
                          class="bel-edit-input"
                          [value]="editMessageContent"
                          (input)="editMessageContent = ($any($event.target).value)"
                          (keydown)="onEditKeyPress($event, message)"
                          rows="3"
                          placeholder="Modifier votre message...">
                        </textarea>
                        <div class="bel-edit-actions">
                          <button class="bel-btn-cancel" (click)="cancelEditing()">Annuler</button>
                          <button class="bel-btn-save" (click)="saveEditedMessage()">Enregistrer</button>
                        </div>
                      </div>
                    }
                    
                    <!-- AFFICHAGE NORMAL -->
                    @else {
                      <!-- En-t√™te du message -->
                      @if (!isMyMessage(message) && !message.isDeleted) {
                        <div class="bel-message-header">
                          <div class="bel-message-sender-info">
                            @if (message.fromUserAvatar) {
                              <img [src]="message.fromUserAvatar" class="bel-user-avatar" alt="Avatar">
                            } @else {
                              <div class="bel-user-avatar-placeholder">
                                {{ message.fromUserName.charAt(0).toUpperCase() }}
                              </div>
                            }
                            <strong class="bel-message-sender">{{ message.fromUserName }}</strong>
                          </div>
                        </div>
                      }

                      <!-- Contenu du message -->
                      <div class="bel-message-content">
                        @if (message.isDeleted) {
                          <span class="bel-deleted-message">Message supprim√©</span>
                        } @else {
                          {{ message.content }}
                          
                          <!-- Indicateur message √©dit√© -->
                          @if (message.isEdited) {
                            <span class="bel-edited-badge">(modifi√©)</span>
                          }
                        }
                      </div>

                      <!-- Pied du message -->
                      <div class="bel-message-footer">
                        <span class="bel-message-time">
                          {{ formatMessageTime(message.timestamp) }}
                        </span>
                        
                        <!-- Indicateurs de statut -->
                        @if (isMyMessage(message) && !message.isDeleted) {
                          <span class="bel-message-status" [title]="message.status">
                            {{ getMessageStatus(message) }}
                          </span>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- INDICATEUR DE R√âPONSE EN COURS -->
        @if (replyingTo) {
          <div class="bel-reply-preview">
            <div class="bel-reply-preview-content">
              <strong>{{ replyingTo.fromUserName }}</strong>
              <p>{{ replyingTo.content?.substring(0, 50) }}{{ replyingTo.content && replyingTo.content.length > 50 ? '...' : '' }}</p>
            </div>
            <button (click)="cancelReply()" class="bel-cancel-reply" title="Annuler la r√©ponse">
              √ó
            </button>
          </div>
        }

        <!-- Input d'envoi -->
        <footer class="bel-chat-input">
          <div class="bel-input-container">
            
            <!-- BOUTON √âMOJI -->
            <button 
              class="bel-emoji-btn"
              (click)="toggleEmojiPicker($event)"
              type="button"
              title="√âmojis">
              üòä
            </button>
            
            <textarea
              #messageInput
              [(ngModel)]="newMessage"
              (keydown)="onKeyPress($event)"
              placeholder="Tapez votre message..."
              class="bel-message-input"
              rows="1"
              [disabled]="isSending">
            </textarea>

            <button 
              class="bel-send-btn"
              (click)="replyingTo ? sendMessageWithReply() : sendMessage()"
              [disabled]="!newMessage.trim() || isSending"
              [class.sending]="isSending">
              {{ isSending ? '‚è≥' : '‚û§' }}
            </button>
          </div>

          <!-- S√âLECTEUR D'√âMOJIS -->
          @if (showEmojiPicker) {
            <div class="bel-emoji-picker">
              <div class="bel-emoji-grid">
                <span *ngFor="let emoji of ['üòÄ', 'üòÇ', 'ü•∞', 'üòé', 'ü§î', 'üëè', 'üéâ', '‚ù§Ô∏è', 'üî•', 'üëç', 'üò¢', 'üò°', 'ü§Ø', 'üëÄ', 'üôè', 'üíØ', '‚ú®', 'üåü', 'üí™', 'üéØ']"
                      class="bel-emoji"
                      (click)="addEmoji(emoji)">
                  {{ emoji }}
                </span>
              </div>
            </div>
          }
        </footer>

      </div>
    }

    <!-- ONGLET MESSAGES PRIV√âS -->
    @if (activeTab === 'private') {
      <div class="bel-private-chat-container">
        
        <!-- √âtat de d√©veloppement -->
        <div class="bel-feature-development">
          <div class="bel-development-icon">üöß</div>
          <h3>Messagerie Priv√©e</h3>
          <p class="bel-development-text">
            Fonctionnalit√© en cours de d√©veloppement
          </p>
          <p class="bel-feature-description">
            Les messages priv√©s seront chiffr√©s de bout en bout pour garantir votre confidentialit√©.
          </p>
        </div>

      </div>
    }

  </main>

  <!-- MENU CONTEXTUEL -->
  @if (contextMenu.visible) {
    <div class="bel-context-menu"
         [style.left.px]="contextMenu.x"
         [style.top.px]="contextMenu.y">
      @for (action of contextMenu.actions; track action.type) {
        <button class="bel-context-menu-item" (click)="executeContextAction(action)">
          <span class="bel-context-icon">{{ action.icon }}</span>
          <span class="bel-context-label">{{ action.label }}</span>
        </button>
      }
    </div>
  }

</div>
<div class="bel-messaging-container">
  
   <div class="bel-emoji-overlay" 
       [class.active]="showEmojiPicker"
       (click)="showEmojiPicker = false">
  </div>
  <!-- Header Principal -->
  <header class="bel-messaging-header">
    <p>Communiquez avec votre communautÃ© et vos contacts</p>
  </header>

  <!-- Navigation par Onglets -->
  <nav class="bel-messaging-tabs">
    <button 
      class="bel-tab-button" 
      [class.active]="activeTab === 'group'"
      (click)="setActiveTab('group')">
      ğŸ’¬ Chat de Groupe
    </button>
    <button 
      class="bel-tab-button" 
      [class.active]="activeTab === 'private'"
      (click)="setActiveTab('private')">
      ğŸ‘¤ Messages PrivÃ©s
    </button>
  </nav>

  <!-- Contenu des Onglets -->
  <main class="bel-messaging-content">
    
    <!-- ONGLET CHAT DE GROUPE -->
    @if (activeTab === 'group') {
      <div class="bel-group-chat-container">
        
        <!-- Header du Groupe -->
        <div class="bel-group-header">
          <div class="bel-group-info">
            <h2>Chat de Groupe - {{ userCommunity }}</h2>
          </div>
          <div class="bel-group-members">
            <span class="bel-members-count">ğŸ‘¥ {{ (groupConversation$ | async)?.participants?.length || 0 }} membres</span>
          </div>
        </div>

        <!-- Zone des Messages -->
        <div class="bel-chat-messages" #messagesContainer>
          @if ((messages$ | async)?.length === 0) {
            <div class="bel-no-messages">
              <div class="bel-no-messages-icon">ğŸ’¬</div>
              <h3>Aucun message</h3>
              <p>Soyez le premier Ã  envoyer un message dans le groupe !</p>
            </div>
          } @else {
            <div class="bel-messages-list">
              @for (message of messages$ | async; track message.id) {
                <app-message-bubble
                  [message]="message"
                  [currentUser]="currentUser"
                  [editingMessageId]="editingMessageId"
                  [editMessageContent]="editMessageContent"
                  (contextMenuRequest)="showContextMenu($event.event, $event.message)"
                  (scrollToRequest)="scrollToMessage($event)"
                  (editKeydown)="onEditKeyPress($event.event, $event.message)"
                  (editInput)="editMessageContent = $event"
                  (cancelEditRequest)="cancelEditing()"
                  (saveEditRequest)="saveEditedMessage()">
                </app-message-bubble>
              }
            </div>
          }
        </div>

        <!-- âœ… INDICATEUR "EN TRAIN D'Ã‰CRIRE" -->
        <div class="bel-typing-indicator-container">
          @if (typingUsers.size > 0) {
            <span class="bel-typing-indicator">{{ Array.from(typingUsers.values())[0].pseudo }} est en train d'Ã©crire...</span>
          }
        </div>

        <!-- INDICATEUR DE RÃ‰PONSE EN COURS -->
        @if (replyingTo) {
          <div class="bel-reply-preview">
            <div class="bel-reply-preview-content">
              <strong>{{ replyingTo.fromUserName }}</strong>
              <p>{{ replyingTo.content?.substring(0, 50) }}{{ replyingTo.content && replyingTo.content.length > 50 ? '...' : '' }}</p>
            </div>
            <button (click)="cancelReply()" class="bel-cancel-reply" title="Annuler la rÃ©ponse">
              Ã—
            </button>
          </div>
        }

        <!-- Input d'envoi -->
        <footer class="bel-chat-input">
          <div class="bel-input-container">
            
            <!-- BOUTON Ã‰MOJI -->
            <button 
              class="bel-emoji-btn"
              (click)="toggleEmojiPicker($event)"
              type="button"
              title="Ã‰mojis">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2.5-6.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm5 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm-2.5-4c-1.76 0-3.22 1.03-3.88 2.5h7.76c-.66-1.47-2.12-2.5-3.88-2.5z"/>
              </svg>
            </button>
            
            <textarea
              #messageInput
              [(ngModel)]="newMessage"
              (keydown)="onKeyPress($event)"
              placeholder="Tapez votre message..."
              class="bel-message-input"
              rows="1"
              [disabled]="isSending">
            </textarea>

            <button 
              class="bel-send-btn"
              (click)="replyingTo ? sendMessageWithReply() : sendMessage()"
              [disabled]="!newMessage.trim() || isSending"
              [class.sending]="isSending">
              <div *ngIf="isSending" class="sending-spinner"></div>
              <svg *ngIf="!isSending" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </div>

          <!-- SÃ‰LECTEUR D'Ã‰MOJIS -->
          @if (showEmojiPicker) {
            <div class="bel-emoji-picker">
              <div class="bel-emoji-grid">
                @for (emoji of ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤”', 'ğŸ‘', 'ğŸ‰', 'â¤ï¸', 'ğŸ”¥', 'ğŸ‘', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ¤¯', 'ğŸ‘€', 'ğŸ™', 'ğŸ’¯', 'âœ¨', 'ğŸŒŸ', 'ğŸ’ª', 'ğŸ¯']; track emoji) {
                  <span
                      class="bel-emoji"
                      (click)="addEmoji(emoji)">
                    {{ emoji }}
                  </span>
                }
              </div>  
            </div>
          }
        </footer>
      </div>
    }

    <!-- ONGLET MESSAGES PRIVÃ‰S -->
    @if (activeTab === 'private') {
      <div class="bel-private-chat-container">
        
        <!-- Ã‰tat de dÃ©veloppement -->
        <div class="bel-feature-development">
          <div class="bel-development-icon">ğŸš§</div>
          <h3>Messagerie PrivÃ©e</h3>
          <p class="bel-development-text">
            FonctionnalitÃ© en cours de dÃ©veloppement
          </p>
          <p class="bel-feature-description">
            Les messages privÃ©s seront chiffrÃ©s de bout en bout pour garantir votre confidentialitÃ©.
          </p>
        </div>

      </div>
    }
  </main>
  <!-- MENU CONTEXTUEL -->
  @if (contextMenu.visible) {
    <div class="bel-context-menu"
         [style.left.px]="contextMenu.x"
         [style.top.px]="contextMenu.y">
      @for (action of contextMenu.actions; track action.type) {
        <button class="bel-context-menu-item" (click)="executeContextAction(action)">
          <span class="bel-context-icon">
            <!-- IcÃ´nes SVG pour le menu contextuel -->
            <svg *ngIf="action.icon === 'reply'" viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>
            <svg *ngIf="action.icon === 'edit'" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            <svg *ngIf="action.icon === 'copy'" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            <svg *ngIf="action.icon === 'delete' || action.icon === 'delete_outline'" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </span>
          <span class="bel-context-label">{{ action.label }}</span>
        </button>
      }
    </div>
  }
</div>
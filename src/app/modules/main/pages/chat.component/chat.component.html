<div class="bel-chat-container">
  <header class="bel-chat-header">
    <button (click)="goBack()" class="bel-back-btn" aria-label="Retour">
      &larr;
    </button>
    <div class="bel-chat-info" *ngIf="conversation$ | async as conversation">
      <img [src]="conversation.avatar || 'assets/images/default-group.png'" alt="Avatar" class="bel-avatar">
      <div class="bel-chat-meta">
        <h2 class="bel-chat-title">{{ conversation.name }}</h2>
        <div class="bel-chat-subtitle">
          <span *ngIf="typingUsers.length > 0" class="bel-typing-indicator">
            {{ getTypingIndicator() }}
          </span>
          <span *ngIf="typingUsers.length === 0 && conversation.type === 'group'" class="bel-badge-group">
            {{ (conversation.participants.length || 0) }} membres
          </span>
        </div>
      </div>
    </div>
  </header>

  <div #messagesContainer class="bel-messages-container">
    <div *ngIf="messages.length === 0" class="bel-chat-empty">
      <div class="bel-empty-illustration">üí¨</div>
      <h3 class="bel-empty-title">Commencez la conversation</h3>
      <p class="bel-empty-description">
        Soyez le premier √† envoyer un message dans {{ (conversation$ | async)?.name || 'cette conversation' }}
      </p>
    </div>

    <div class="bel-messages-timeline">
      <div 
        *ngFor="let message of messages"
        [id]="'message-' + message.id"
        class="bel-message-item"
        [ngClass]="{
          'bel-message-outgoing': isMyMessage(message),
          'bel-message-incoming': !isMyMessage(message)
        }"
        (contextmenu)="showContextMenu($event, message)">
        
        <div class="bel-message-bubble">
          <!-- Reply Indicator -->
          <div *ngIf="message.replyTo" class="reply-indicator" (click)="scrollToMessage(message.replyTo.messageId)">
            <div class="reply-content">
              <strong>{{ message.replyTo.fromUserName }}</strong>
              <p>{{ getReplyPreview(message) }}</p>
            </div>
          </div>

          <!-- Edit Mode -->
          <div *ngIf="editingMessageId === message.id" class="message-edit">
            <textarea 
              [id]="'edit-input-' + message.id"
              class="edit-input"
              [(ngModel)]="editMessageContent"
              (keydown.enter)="saveEditedMessage()"
              (keydown.escape)="cancelEditing()">
            </textarea>
            <div class="edit-actions">
              <button (click)="cancelEditing()" class="btn-cancel">Annuler</button>
              <button (click)="saveEditedMessage()" class="btn-save">Enregistrer</button>
            </div>
          </div>

          <!-- Normal Display Mode -->
          <div *ngIf="editingMessageId !== message.id">
            <div class="message-header" *ngIf="!isMyMessage(message) && !message.isDeleted">
              <strong>{{ message.fromUserName }}</strong>
            </div>

            <div class="message-content">
              <span *ngIf="message.isDeleted" class="deleted-message">Message supprim√©</span>
              <span *ngIf="!message.isDeleted">{{ message.content }}</span>
            </div>

            <div class="message-footer">
              <span *ngIf="message.isEdited && !message.isDeleted" class="edited-badge">(modifi√©)</span>
              <span class="message-time">{{ formatMessageTime(message.timestamp) }}</span>
              
              <!-- Statut du message -->
              <span *ngIf="isMyMessage(message) && !message.isDeleted" class="message-status" [title]="message.status">
                <svg *ngIf="message.status === 'sent'" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="m9.55 18l-5.7-5.7l1.425-1.425L9.55 15.15l9.175-9.175L20.15 7.4z"/></svg>
                <svg *ngIf="message.status === 'delivered'" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="m1.4 13.825l1.4-1.4l6.35 6.35L21.6 6.325l1.4 1.4L9.15 21.6zM6.35 13.8L7.75 12.4L9.15 13.8L7.75 15.2zM18.175 9.175l1.425-1.425l-6.35-6.35l-1.4 1.4z"/></svg>
                <svg *ngIf="message.status === 'read'" width="16" height="16" viewBox="0 0 24 24"><path fill="#008751" d="m1.4 13.825l1.4-1.4l6.35 6.35L21.6 6.325l1.4 1.4L9.15 21.6zM6.35 13.8L7.75 12.4L9.15 13.8L7.75 15.2zM18.175 9.175l1.425-1.425l-6.35-6.35l-1.4 1.4z"/></svg>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reply Preview -->
  <div *ngIf="replyingTo" class="reply-preview">
    <div class="reply-preview-content">
      <strong>R√©pondre √† {{ replyingTo.fromUserName }}</strong>
      <p>{{ getReplyPreview(replyingTo) }}</p>
    </div>
    <button (click)="cancelReply()" class="cancel-reply-btn" title="Annuler la r√©ponse">&times;</button>
  </div>

  <footer class="bel-chat-footer">
    <div class="bel-input-wrapper">
      <div class="bel-textarea-container">
        <textarea
          #messageInput
          [(ngModel)]="newMessage"
          (keydown)="onKeydown($event)"
          (input)="onInput()"
          placeholder="√âcrivez votre message..."
          class="bel-message-textarea"
          rows="1"
          [disabled]="isSending"
          aria-label="Zone de saisie du message">
        </textarea>
        
        <div class="bel-keyboard-hint">
          <span class="bel-hint-text"><kbd>Entr√©e</kbd> pour envoyer</span>
          <span class="bel-hint-text">‚Ä¢ <kbd>Shift</kbd>+<kbd>Entr√©e</kbd> pour une nouvelle ligne</span>
        </div>
      </div>

      <button 
        class="bel-send-button"
        [class.bel-sending]="isSending"
        [disabled]="!newMessage.trim() || isSending"
        (click)="sendMessage()"
        title="Envoyer le message"
        aria-label="Envoyer le message">
        
        <span class="bel-send-icon">
          <svg class="bel-send-svg" viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </span>
      </button>
    </div>
  </footer>

  <!-- Context Menu -->
  <div *ngIf="contextMenu.visible" 
       class="context-menu" 
       [style.left.px]="contextMenu.x" 
       [style.top.px]="contextMenu.y">
    <button *ngFor="let action of contextMenu.actions" (click)="executeContextAction(action.type)" class="context-menu-item">
      {{ action.label }}
    </button>
  </div>

</div>
